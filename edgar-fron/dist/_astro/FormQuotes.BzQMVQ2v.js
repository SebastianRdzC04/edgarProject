import{j as e}from"./jsx-runtime.D_zvdyIk.js";import{r}from"./index.BVOCwoKb.js";function O(){const[n,y]=r.useState(""),[c,b]=r.useState(""),[d,j]=r.useState(""),[u,N]=r.useState(0),[m,v]=r.useState(""),[w,M]=r.useState([]),[o,x]=r.useState([]),[S,q]=r.useState(!0),[h,C]=r.useState(!1),[p,k]=r.useState({show:!1,type:"",message:""}),[F,_]=r.useState([]);r.useEffect(()=>{const t=async()=>{try{const s=await fetch("https://apiedgar.kysedomi.lat/materials/");if(!s.ok)throw new Error("Failed to fetch materials");const i=await s.json();M(i)}catch{l("error","Error al cargar materiales")}finally{q(!1)}},a=async()=>{try{const s=await fetch("https://apiedgar.kysedomi.lat/users/all");if(!s.ok)throw new Error("Failed to fetch users");const i=await s.json();_(i),i.length>0&&v(i[0].id)}catch{l("error","Error al cargar usuarios")}};t(),a()},[]);const g={base:{padding:"10px",marginBottom:"16px",borderRadius:"4px"},success:{backgroundColor:"#d1fae5",color:"#065f46"},error:{backgroundColor:"#fee2e2",color:"#b91c1c"}},z={display:"inline-block",marginRight:"8px",animation:"spin 1s linear infinite"},l=(t,a)=>{k({show:!0,type:t,message:a}),setTimeout(()=>{k({show:!1,type:"",message:""})},3e3)},T=t=>{const a=w.find(s=>s.id===t);if(a){if(o.some(s=>s.material_id===t)){l("error","Este material ya ha sido agregado");return}x([...o,{material_id:t,name:a.name}])}},A=t=>{x(o.filter(a=>a.material_id!==t))},D=async t=>{t.preventDefault(),C(!0);try{const a=await fetch("https://apiedgar.kysedomi.lat/quotes/",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({title:n,text:c,address:d,price:Number(u),user_id:m})});if(console.log("Quote payload:",{title:n,text:c,address:d,price:Number(u),user_id:m}),!a.ok){const f=await a.json();throw new Error(f.message||"Error al crear la cotización")}const i=(await a.json()).id;if(o.length>0)for(const f of o){const E=await fetch("https://apiedgar.kysedomi.lat/quote-materials/",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({quote_id:i,material_id:f.material_id,quantity:0,price:0})});E.ok||console.error("Error adding material to quote:",await E.json())}l("success","Cotización creada exitosamente"),L()}catch(a){l("error",a.message||"Ocurrió un error al crear la cotización"),console.error("Error details:",a)}finally{C(!1)}},L=()=>{y(""),b(""),j(""),N(0),x([])};return e.jsxs("div",{className:"bg-white shadow-md rounded-xl w-full",children:[e.jsxs("div",{className:"p-6 border-b border-gray-200 bg-gray-800 text-white",children:[e.jsxs("h3",{className:"text-2xl font-bold",children:["Crear ",e.jsx("span",{className:"text-blue-300",children:"Cotización"})]}),e.jsx("p",{className:"mt-2 text-gray-300",children:"Complete el formulario para crear una nueva cotización."})]}),e.jsx("style",{children:`
        @keyframes spin {
          from { transform: rotate(0deg); }
          to { transform: rotate(360deg); }
        }
        `}),e.jsxs("div",{className:"p-6",children:[p.show&&e.jsx("div",{style:{...g.base,...p.type==="success"?g.success:g.error},children:p.message}),e.jsxs("form",{onSubmit:D,className:"flex flex-col gap-6",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[e.jsxs("div",{className:"flex flex-col gap-2",children:[e.jsx("label",{htmlFor:"title",className:"text-sm font-medium text-gray-700",children:"Título de la Cotización"}),e.jsx("input",{id:"title",type:"text",placeholder:"Ej: Remodelación de cocina",value:n,onChange:t=>y(t.target.value),required:!0,className:"px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"})]}),e.jsxs("div",{className:"flex flex-col gap-2",children:[e.jsx("label",{htmlFor:"userId",className:"text-sm font-medium text-gray-700",children:"Cliente"}),e.jsxs("select",{id:"userId",value:m,onChange:t=>v(t.target.value),required:!0,className:"px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500",children:[e.jsx("option",{value:"",children:"Seleccione un cliente"}),F.map(t=>e.jsx("option",{value:t.id,children:t.username},t.id))]})]})]}),e.jsxs("div",{className:"flex flex-col gap-2",children:[e.jsx("label",{htmlFor:"address",className:"text-sm font-medium text-gray-700",children:"Dirección"}),e.jsx("input",{id:"address",type:"text",placeholder:"Ej: Av. Principal #123, Ciudad",value:d,onChange:t=>j(t.target.value),required:!0,className:"px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"})]}),e.jsxs("div",{className:"flex flex-col gap-2",children:[e.jsx("label",{htmlFor:"text",className:"text-sm font-medium text-gray-700",children:"Descripción de la Cotización"}),e.jsx("textarea",{id:"text",placeholder:"Descripción detallada del trabajo a realizar",value:c,onChange:t=>b(t.target.value),required:!0,rows:4,className:"px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"})]}),e.jsxs("div",{className:"flex flex-col gap-2",children:[e.jsx("label",{htmlFor:"price",className:"text-sm font-medium text-gray-700",children:"Precio Estimado (MXN)"}),e.jsx("input",{id:"price",type:"number",min:"0",step:"0.01",value:u,onChange:t=>N(parseFloat(t.target.value)),required:!0,className:"px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"})]}),e.jsxs("div",{className:"border-t border-gray-200 pt-6",children:[e.jsx("h4",{className:"text-lg font-medium text-gray-800 mb-4",children:"Materiales"}),e.jsxs("div",{className:"mb-4",children:[e.jsx("label",{htmlFor:"addMaterial",className:"text-sm font-medium text-gray-700",children:"Agregar Material"}),e.jsxs("div",{className:"flex space-x-2 mt-1",children:[e.jsxs("select",{id:"addMaterial",disabled:S,className:"flex-1 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500",children:[e.jsx("option",{value:"",children:"Seleccione un material"}),w.map(t=>e.jsx("option",{value:t.id,children:t.name},t.id))]}),e.jsx("button",{type:"button",onClick:()=>{const t=document.getElementById("addMaterial");t.value&&(T(t.value),t.value="")},disabled:S,className:"px-3 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 disabled:bg-gray-300",children:"Agregar"})]})]}),e.jsxs("div",{className:"bg-gray-50 rounded-md p-4",children:[e.jsx("h5",{className:"text-sm font-medium text-gray-700 mb-2",children:"Materiales Seleccionados"}),o.length>0?e.jsx("ul",{className:"divide-y divide-gray-200",children:o.map(t=>e.jsxs("li",{className:"py-3 flex justify-between items-center",children:[e.jsx("span",{className:"text-sm text-gray-800",children:t.name}),e.jsx("button",{type:"button",onClick:()=>A(t.material_id),className:"text-red-600 hover:text-red-800",children:e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-5 w-5",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"})})})]},t.material_id))}):e.jsx("p",{className:"text-sm text-gray-500 py-2",children:"No hay materiales seleccionados"})]})]}),e.jsx("button",{type:"submit",disabled:h,className:`mt-4 px-4 py-2 bg-blue-600 text-white font-medium rounded-md ${h?"opacity-70 cursor-not-allowed":"hover:bg-blue-700"} transition-colors`,children:h?e.jsxs("span",{className:"flex items-center justify-center",children:[e.jsx("span",{style:z,children:"◌"}),"Guardando..."]}):"Crear Cotización"})]})]})]})}export{O as default};
